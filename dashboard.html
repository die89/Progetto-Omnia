<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Progetto Omnia ‚Äì Dashboard sensori & pompa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js per il grafico -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #020617;
      --bg-soft: #020617;
      --bg-panel: #020617;
      --border: #1f2937;
      --accent: #facc15;
      --accent-soft: #facc1533;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --success: #4ade80;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(2, 6, 23, 0.97);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-circle {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 2px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 15px;
      color: #000;
      background: radial-gradient(circle at top, #facc15, #f97316);
      box-shadow: 0 0 16px var(--accent-soft);
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    header .subtitle {
      margin: 0;
      font-size: 11px;
      color: var(--text-muted);
    }
    .top-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .chip {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #0f172a;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }
    a.home-link {
      font-size: 12px;
      text-decoration: none;
      color: var(--accent);
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      background: rgba(15,23,42,0.9);
    }
    a.home-link:hover {
      background: rgba(250,204,21,0.1);
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 14px;
      padding: 12px 14px 16px;
    }
    @media (max-width: 800px) {
      main {
        grid-template-columns: 1fr;
      }
    }
    .panel {
      background: rgba(2, 6, 23, 0.96);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 14px 14px 12px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.65);
    }
    .panel h2 {
      margin: 0 0 8px;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .panel h2 span.icon {
      font-size: 17px;
    }
    .muted {
      font-size: 11px;
      color: var(--text-muted);
    }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid transparent;
    }
    .badge-on {
      background: rgba(74, 222, 128, 0.15);
      border-color: #4ade80;
      color: #bbf7d0;
    }
    .badge-off {
      background: rgba(239, 68, 68, 0.15);
      border-color: #ef4444;
      color: #fecaca;
    }
    .badge-pending {
      background: rgba(249, 115, 22, 0.15);
      border-color: #f97316;
      color: #fed7aa;
    }
    .badge-error {
      background: rgba(244, 63, 94, 0.15);
      border-color: #f97373;
      color: #fee2e2;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
      margin-bottom: 6px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.08s ease;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    button[disabled] {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }
    .btn-on {
      background: #22c55e;
      color: #022c22;
      box-shadow: 0 6px 17px rgba(34,197,94,0.45);
    }
    .btn-off {
      background: #ef4444;
      color: #450a0a;
      box-shadow: 0 6px 17px rgba(239,68,68,0.45);
    }
    .btn-refresh {
      background: #0ea5e9;
      color: #02131c;
      box-shadow: 0 6px 17px rgba(14,165,233,0.45);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 4px;
    }
    th, td {
      padding: 6px 4px;
      text-align: left;
    }
    th {
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      font-weight: 500;
    }
    tr:nth-child(even) td {
      background: #020617;
    }
    .val {
      font-variant-numeric: tabular-nums;
    }

    #log {
      font-size: 11px;
      max-height: 160px;
      overflow-y: auto;
      background: #020617;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px;
      white-space: pre-line;
    }
    .log-line { margin: 0 0 2px; }
    .log-ok { color: #a7f3d0; }
    .log-warn { color: #facc15; }
    .log-err { color: #fecaca; }

    footer {
      text-align: center;
      font-size: 10px;
      color: var(--text-muted);
      padding: 4px 0 8px;
    }

    canvas {
      max-height: 260px;
    }
  </style>
</head>
<body>
<header>
  <div class="logo">
    <div class="logo-circle">O</div>
    <div>
      <h1>Progetto Omnia ‚Äì Dashboard</h1>
      <p class="subtitle">Arduino UNO R4 WiFi ¬∑ ThingSpeak canale 2862116</p>
    </div>
  </div>
  <div class="top-actions">
    <div class="chip" id="last-sync">Ultimo aggiornamento: ‚Äì</div>
    <a class="home-link" href="index.html">‚Üê Home</a>
  </div>
</header>

<main>
  <!-- Colonna sinistra: pompa + sensori + log -->
  <section class="panel">
    <h2><span class="icon">‚öôÔ∏è</span> Pompa / Rel√®</h2>
    <div class="muted">
      Stato reale da Arduino (field2) e comandi via ThingSpeak (field1).
    </div>

    <div style="margin-top:8px;">
      <div class="muted">Stato reale pompa (field2):</div>
      <div id="pump-status-badge" class="badge badge-error">Sconosciuto</div>
    </div>
    <div style="margin-top:6px;">
      <div class="muted">Ultimo comando inviato (field1):</div>
      <div id="command-status" class="badge badge-error">Nessuno</div>
    </div>

    <div class="btn-row">
      <button id="btn-on" class="btn-on" onclick="setPump(1)">‚ñ∂ POMPA ON</button>
      <button id="btn-off" class="btn-off" onclick="setPump(0)">‚ñ† POMPA OFF</button>
      <button class="btn-refresh" onclick="refreshAll()">‚ü≥ Aggiorna</button>
    </div>

    <div id="pump-note" class="muted" style="margin-top:4px;">
      In attesa dei dati da ThingSpeak‚Ä¶
    </div>

    <hr style="border:none; border-top:1px solid var(--border); margin:12px 0 8px;" />

    <h2><span class="icon">üå°Ô∏è</span> Sensori BME280 (Testa / Base)</h2>
    <table>
      <thead>
        <tr>
          <th>Posizione</th>
          <th>T [¬∞C]</th>
          <th>UR [%]</th>
          <th>Press. [hPa]</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Testa (field3‚Äì5)</td>
          <td class="val" id="t-testa">‚Äì</td>
          <td class="val" id="h-testa">‚Äì</td>
          <td class="val" id="p-testa">‚Äì</td>
        </tr>
        <tr>
          <td>Base (field6‚Äì8)</td>
          <td class="val" id="t-base">‚Äì</td>
          <td class="val" id="h-base">‚Äì</td>
          <td class="val" id="p-base">‚Äì</td>
        </tr>
      </tbody>
    </table>
    <div id="sensors-note" class="muted" style="margin-top:4px;">
      Ultimo campione: ‚Äì
    </div>

    <hr style="border:none; border-top:1px solid var(--border); margin:12px 0 8px;" />

    <h2><span class="icon">üìü</span> Log / Diagnostica</h2>
    <div id="log"></div>
  </section>

  <!-- Colonna destra: grafico -->
  <section class="panel">
    <h2><span class="icon">üìà</span> Temperature ultime letture</h2>
    <div class="muted">
      Grafico delle ultime 50 letture da ThingSpeak (field3 = T testa, field6 = T base).
    </div>
    <div style="margin-top:6px;">
      <canvas id="tempChart"></canvas>
    </div>
  </section>
</main>

<footer>
  Dati letti da ThingSpeak via API JSON ¬∑ aggiornamento automatico ogni 10 s ¬∑ attenzione ai limiti di rate del piano free.
</footer>

<script>
  // === CONFIGURAZIONE THINGSPEAK ===
  const CHANNEL_ID    = 2862116;
  const READ_API_KEY  = "IZCUGF40MLOCNBG9";
  const WRITE_API_KEY = "FBHJWWWILCJK3YFT";

  const POLL_INTERVAL_MS = 10000;   // lettura ogni 10 s

  // === RIFERIMENTI DOM ===
  const pumpBadge    = document.getElementById("pump-status-badge");
  const commandBadge = document.getElementById("command-status");
  const pumpNote     = document.getElementById("pump-note");
  const sensorsNote  = document.getElementById("sensors-note");
  const lastSync     = document.getElementById("last-sync");
  const logDiv       = document.getElementById("log");
  const btnOn        = document.getElementById("btn-on");
  const btnOff       = document.getElementById("btn-off");

  const tTestaSpan = document.getElementById("t-testa");
  const hTestaSpan = document.getElementById("h-testa");
  const pTestaSpan = document.getElementById("p-testa");
  const tBaseSpan  = document.getElementById("t-base");
  const hBaseSpan  = document.getElementById("h-base");
  const pBaseSpan  = document.getElementById("p-base");

  let lastCommand = null;
  let awaitingConfirm = false;
  let lastCommandTime = 0;

  // === GRAFICO Chart.js ===
  let tempChart = null;

  function initChart() {
    const ctx = document.getElementById("tempChart").getContext("2d");
    tempChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "T Testa [¬∞C]",
            data: [],
            borderColor: "rgba(250, 204, 21, 1)",
            backgroundColor: "rgba(250, 204, 21, 0.15)",
            borderWidth: 2,
            pointRadius: 1.5,
            tension: 0.3
          },
          {
            label: "T Base [¬∞C]",
            data: [],
            borderColor: "rgba(56, 189, 248, 1)",
            backgroundColor: "rgba(56, 189, 248, 0.15)",
            borderWidth: 2,
            pointRadius: 1.5,
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: { color: "#9ca3af", maxRotation: 0, autoSkip: true, maxTicksLimit: 6 },
            grid: { display: false }
          },
          y: {
            ticks: { color: "#9ca3af" },
            grid: { color: "#1f2937" }
          }
        },
        plugins: {
          legend: {
            labels: { color: "#e5e7eb", font: { size: 11 } }
          }
        }
      }
    });
  }

  // === LOG ===
  function log(msg, level = "ok") {
    const now = new Date().toLocaleTimeString();
    const div = document.createElement("div");
    div.className = `log-line log-${level}`;
    div.textContent = `[${now}] ${msg}`;
    logDiv.prepend(div);
  }

  // === UTILIT√Ä UI ===
  function setPumpBadge(state) {
    pumpBadge.className = "badge";
    if (state === 1) {
      pumpBadge.classList.add("badge-on");
      pumpBadge.textContent = "ON";
    } else if (state === 0) {
      pumpBadge.classList.add("badge-off");
      pumpBadge.textContent = "OFF";
    } else {
      pumpBadge.classList.add("badge-error");
      pumpBadge.textContent = "Sconosciuto";
    }
  }

  function setCommandBadge(val) {
    commandBadge.className = "badge";
    if (val === 1) {
      commandBadge.classList.add("badge-on");
      commandBadge.textContent = "ON";
    } else if (val === 0) {
      commandBadge.classList.add("badge-off");
      commandBadge.textContent = "OFF";
    } else {
      commandBadge.classList.add("badge-error");
      commandBadge.textContent = "Nessuno";
    }
  }

  function setButtonsEnabled(enabled) {
    btnOn.disabled  = !enabled;
    btnOff.disabled = !enabled;
  }

  // === INVIO COMANDO POMPA ===
  function setPump(value) {
    lastCommand = value;
    awaitingConfirm = true;
    lastCommandTime = Date.now();
    setButtonsEnabled(false);

    pumpNote.textContent = `Invio comando ${value === 1 ? "ON" : "OFF"} a ThingSpeak‚Ä¶`;
    setCommandBadge(value);

    const url = `https://api.thingspeak.com/update?api_key=${WRITE_API_KEY}&field1=${value}`;
    log(`Invio comando field1=${value}`, "ok");

    fetch(url)
      .then(r => r.text())
      .then(data => {
        const id = parseInt(data);
        if (isNaN(id) || id <= 0) {
          log(`ThingSpeak NON ha registrato il comando (risposta: ${data})`, "err");
          pumpNote.textContent = "Errore: comando non registrato (limite di rate o chiave errata).";
          awaitingConfirm = false;
          setButtonsEnabled(true);
        } else {
          log(`Comando registrato su ThingSpeak, entryId=${id}`, "ok");
          pumpNote.textContent = "Comando registrato, in attesa che Arduino aggiorni lo stato‚Ä¶";
        }
      })
      .catch(err => {
        log("Errore invio comando: " + err, "err");
        pumpNote.textContent = "Errore di rete nell‚Äôinvio comando.";
        awaitingConfirm = false;
        setButtonsEnabled(true);
      });
  }

  // === LETTURA COMPLETA ULTIMO CAMPIONE + AGGIORNAMENTO UI ===
  function refreshAll() {
    const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=50`;

    fetch(url)
      .then(r => r.json())
      .then(json => {
        if (!json.feeds || json.feeds.length === 0) {
          log("Nessun feed disponibile dal canale.", "warn");
          return;
        }

        // ultimo feed
        const latest = json.feeds[json.feeds.length - 1];
        const updated = new Date(latest.created_at);

        // Field1 = ultimo comando, Field2 = stato reale pompa
        const f1 = latest.field1 !== null ? parseInt(latest.field1) : null;
        const f2 = latest.field2 !== null ? parseInt(latest.field2) : null;

        setCommandBadge((f1 === 0 || f1 === 1) ? f1 : null);
        setPumpBadge((f2 === 0 || f2 === 1) ? f2 : null);

        if (f2 === 1) {
          pumpNote.textContent = "Pompa segnalata ATTIVA da Arduino.";
        } else if (f2 === 0) {
          pumpNote.textContent = "Pompa segnalata SPENTA da Arduino.";
        } else {
          pumpNote.textContent = "Stato pompa non disponibile.";
        }

        // Conferma comando
        if (awaitingConfirm && (f2 === 0 || f2 === 1)) {
          if (f2 === lastCommand) {
            log("Comando confermato: stato pompa combacia con field1.", "ok");
            pumpNote.textContent += " (comando confermato)";
            awaitingConfirm = false;
          } else if (Date.now() - lastCommandTime > 30000) {
            log("ATTENZIONE: comando non confermato entro 30s.", "warn");
            pumpNote.textContent += " (comando non confermato entro 30s)";
            awaitingConfirm = false;
          }
        }

        // Sensori testa/base (dall‚Äôultimo sample)
        const f3 = latest.field3, f4 = latest.field4, f5 = latest.field5;
        const f6 = latest.field6, f7 = latest.field7, f8 = latest.field8;

        tTestaSpan.textContent = f3 !== null ? parseFloat(f3).toFixed(2) : "‚Äì";
        hTestaSpan.textContent = f4 !== null ? parseFloat(f4).toFixed(2) : "‚Äì";
        pTestaSpan.textContent = f5 !== null ? parseFloat(f5).toFixed(2) : "‚Äì";

        tBaseSpan.textContent  = f6 !== null ? parseFloat(f6).toFixed(2) : "‚Äì";
        hBaseSpan.textContent  = f7 !== null ? parseFloat(f7).toFixed(2) : "‚Äì";
        pBaseSpan.textContent  = f8 !== null ? parseFloat(f8).toFixed(2) : "‚Äì";

        sensorsNote.textContent = "Ultimo campione: " + updated.toLocaleString();
        lastSync.textContent = "Ultimo aggiornamento: " + new Date().toLocaleTimeString();
        setButtonsEnabled(true);

        // === Aggiorna il grafico con T testa/base su tutti i sample ===
        const labels = [];
        const tTestaArray = [];
        const tBaseArray  = [];

        json.feeds.forEach(feed => {
          const ts = new Date(feed.created_at);
          labels.push(ts.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }));
          tTestaArray.push(feed.field3 ? parseFloat(feed.field3) : null);
          tBaseArray.push(feed.field6 ? parseFloat(feed.field6) : null);
        });

        tempChart.data.labels = labels;
        tempChart.data.datasets[0].data = tTestaArray;
        tempChart.data.datasets[1].data = tBaseArray;
        tempChart.update();
      })
      .catch(err => {
        log("Errore lettura dati da ThingSpeak: " + err, "err");
      });
  }

  // === AVVIO ===
  initChart();
  log("Dashboard avviata. Lettura iniziale dati‚Ä¶", "ok");
  refreshAll();
  setInterval(refreshAll, POLL_INTERVAL_MS);
</script>
</body>
</html>
