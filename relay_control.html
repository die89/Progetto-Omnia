<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Controllo Pompa</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h2 {
      margin-bottom: 10px;
    }
    button {
      font-size: 18px;
      padding: 10px 20px;
      margin-right: 10px;
      cursor: pointer;
    }
    #stato-pompa, #stato-comando {
      margin-top: 10px;
      font-size: 16px;
      font-weight: bold;
      padding: 6px 10px;
      display: inline-block;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .on {
      background-color: #4caf50; /* verde */
      color: white;
    }
    .off {
      background-color: #f44336; /* rosso */
      color: white;
    }
    .pending {
      background-color: #ff9800; /* arancione */
      color: white;
    }
    .error {
      background-color: #9c27b0; /* viola */
      color: white;
    }
    #log {
      margin-top: 20px;
      font-size: 13px;
      color: #333;
      white-space: pre-line;
      border-top: 1px solid #ddd;
      padding-top: 10px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h2>Controllo pompa (ThingSpeak)</h2>

  <button onclick="setPompa(1)">POMPA ON</button>
  <button onclick="setPompa(0)">POMPA OFF</button>

  <div id="stato-pompa" class="off">
    Stato pompa: SCONOSCIUTO
  </div>
  <br />
  <div id="stato-comando">
    Ultimo comando (field1): SCONOSCIUTO
  </div>

  <div id="log">Log eventi:\n</div>

  <script>
    // ⚠️ QUI CI SONO GIÀ I TUOI VALORI
    const CHANNEL_ID    = 2862116;                  // tuo Channel ID
    const READ_API_KEY  = "IZCUGF40MLOCNBG9";       // Read API Key
    const WRITE_API_KEY = "FBHJWWWILCJK3YFT";       // Write API Key

    const POLL_INTERVAL_MS   = 5000;   // ogni quanto leggere field1/field2
    const CONFIRM_TIMEOUT_MS = 30000;  // 30s timeout conferma

    const logDiv       = document.getElementById("log");
    const statoPompa   = document.getElementById("stato-pompa");
    const statoComando = document.getElementById("stato-comando");

    let lastCommand       = null;  // 0 o 1
    let awaitingConfirm   = false;
    let lastCommandTimeMs = 0;

    function log(msg) {
      const now = new Date().toLocaleTimeString();
      logDiv.textContent = `[${now}] ${msg}\n` + logDiv.textContent;
      console.log(msg);
    }

    function setStatusPompa(text, cssClass) {
      statoPompa.textContent = text;
      statoPompa.classList.remove("on", "off", "pending", "error");
      if (cssClass) {
        statoPompa.classList.add(cssClass);
      }
    }

    function setStatusComando(text) {
      statoComando.textContent = text;
    }

    // Invia comando pompa (field1 = 0/1) UNA VOLTA
    function setPompa(valore) {
      lastCommand = valore;
      awaitingConfirm = true;
      lastCommandTimeMs = Date.now();

      setStatusPompa(
        `Stato pompa: comando ${valore === 1 ? "ON" : "OFF"} inviato, in attesa conferma...`,
        "pending"
      );

      const url = `https://api.thingspeak.com/update?api_key=${WRITE_API_KEY}&field1=${valore}`;
      log(`Invio comando pompa: field1=${valore}`);

      fetch(url)
        .then(response => response.text())
        .then(data => {
          log(`Risposta ThingSpeak (update): ${data}`);
          if (parseInt(data) <= 0 || isNaN(parseInt(data))) {
            log("Attenzione: ThingSpeak non ha registrato correttamente il comando (ID <= 0).");
          } else {
            // Il comando è stato scritto nel canale -> aggiorno subito la lettura di field1
            refreshComando();
          }
        })
        .catch(err => {
          log("Errore invio comando: " + err);
          setStatusPompa("Errore invio comando a ThingSpeak", "error");
          awaitingConfirm = false;
        });
    }

    // Legge l'ultimo comando (field1)
    function refreshComando() {
      const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/fields/1/last.txt?api_key=${READ_API_KEY}`;
      log("Richiedo ultimo comando (field1)...");

      fetch(url)
        .then(response => response.text())
        .then(text => {
          const valore = text.trim();
          log(`Valore ricevuto da field1: '${valore}'`);

          if (valore === "1") {
            setStatusComando("Ultimo comando (field1): ON");
          } else if (valore === "0") {
            setStatusComando("Ultimo comando (field1): OFF");
          } else {
            setStatusComando("Ultimo comando (field1): SCONOSCIUTO");
          }
        })
        .catch(err => {
          log("Errore lettura comando (field1): " + err);
        });
    }

    // Legge lo stato reale della pompa da field2 (0/1)
    function refreshStatoPompa() {
      const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/fields/2/last.txt?api_key=${READ_API_KEY}`;
      log("Richiedo stato pompa da field2...");

      fetch(url)
        .then(response => response.text())
        .then(text => {
          const valore = text.trim();
          log(`Valore ricevuto da field2: '${valore}'`);

          let statoTesto  = "Stato pompa: SCONOSCIUTO";
          let statoClasse = null;

          if (valore === "1") {
            statoTesto  = "Stato pompa: ON";
            statoClasse = "on";
          } else if (valore === "0") {
            statoTesto  = "Stato pompa: OFF";
            statoClasse = "off";
          }

          // Gestione conferma comando
          if (awaitingConfirm && (valore === "0" || valore === "1")) {
            const currentState = parseInt(valore);
            const nowMs = Date.now();

            if (currentState === lastCommand) {
              statoTesto += " (comando confermato)";
              awaitingConfirm = false;
              log("Comando confermato da Arduino (field2 corrisponde a field1).");
            } else if (nowMs - lastCommandTimeMs > CONFIRM_TIMEOUT_MS) {
              statoTesto += " (comando NON confermato nei tempi previsti)";
              statoClasse = "error";
              awaitingConfirm = false;
              log("ATTENZIONE: comando NON confermato entro il timeout.");
            } else {
              statoTesto += " (in attesa conferma...)";
              statoClasse = "pending";
              log("Ancora in attesa che Arduino aggiorni field2...");
            }
          }

          setStatusPompa(statoTesto, statoClasse);
        })
        .catch(err => {
          log("Errore lettura stato pompa: " + err);
        });
    }

    // Aggiorna automaticamente campo comando + stato pompa
    function periodicRefresh() {
      refreshComando();
      refreshStatoPompa();
    }

    setInterval(periodicRefresh, POLL_INTERVAL_MS);

    // Prima lettura all'apertura pagina
    periodicRefresh();
  </script>
</body>
</html>
