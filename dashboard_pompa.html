<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Progetto Omnia - Controllo Pompa & Sensori</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
    }
    header {
      padding: 16px 24px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    header span {
      font-size: 12px;
      color: #9ca3af;
    }
    main {
      padding: 24px;
      max-width: 1100px;
      margin: 0 auto;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .card {
      background: #020617;
      border-radius: 12px;
      padding: 16px 18px;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
    }
    .card h2 {
      font-size: 16px;
      margin: 0 0 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
    }
    .badge-on {
      background: #22c55e33;
      color: #bbf7d0;
      border: 1px solid #22c55e;
    }
    .badge-off {
      background: #ef444433;
      color: #fecaca;
      border: 1px solid #ef4444;
    }
    .badge-pending {
      background: #f9731633;
      color: #fed7aa;
      border: 1px solid #f97316;
    }
    .badge-error {
      background: #e11d4833;
      color: #fecdd3;
      border: 1px solid #e11d48;
    }
    .muted {
      font-size: 12px;
      color: #9ca3af;
    }
    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 9px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.08s ease;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-on {
      background: #22c55e;
      color: #022c22;
      box-shadow: 0 5px 14px rgba(34,197,94,0.35);
    }
    .btn-off {
      background: #ef4444;
      color: #450a0a;
      box-shadow: 0 5px 14px rgba(239,68,68,0.35);
    }
    .btn-refresh {
      background: #0ea5e9;
      color: #02131c;
      box-shadow: 0 5px 14px rgba(14,165,233,0.35);
    }
    button[disabled] {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 4px;
    }
    th, td {
      padding: 6px 4px;
      text-align: left;
    }
    th {
      font-size: 12px;
      color: #9ca3af;
      border-bottom: 1px solid #1f2937;
    }
    tr:nth-child(even) td {
      background: #020617;
    }
    .val {
      font-variant-numeric: tabular-nums;
    }
    #log {
      font-size: 11px;
      max-height: 140px;
      overflow-y: auto;
      background: #020617;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      white-space: pre-line;
    }
    .log-line {
      margin: 0;
    }
    .ok { color: #4ade80; }
    .warn { color: #facc15; }
    .err { color: #fb7185; }
    footer {
      text-align: center;
      font-size: 11px;
      color: #6b7280;
      padding: 10px 0 20px;
    }
    a {
      color: #38bdf8;
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Progetto Omnia – Dashboard Pompa & Sensori</h1>
    <span>Arduino UNO R4 WiFi · ThingSpeak channel 2862116</span>
  </div>
  <div class="muted" id="last-sync">Ultimo aggiornamento: –</div>
</header>

<main>
  <section class="grid">
    <!-- Stato pompa + comandi -->
    <div class="card">
      <h2>Pompa / Relè</h2>
      <div style="display:flex; flex-direction:column; gap:6px;">
        <div>
          <span class="muted">Stato reale (field2): </span>
          <span id="pump-status-badge" class="badge badge-off">Sconosciuto</span>
        </div>

        <div>
          <span class="muted">Ultimo comando inviato (field1): </span>
          <span id="command-status" class="badge badge-off">Nessuno</span>
        </div>

        <div class="btn-row">
          <button class="btn-on" id="btn-on" onclick="setPump(1)">
            ▶ POMPA ON
          </button>
          <button class="btn-off" id="btn-off" onclick="setPump(0)">
            ■ POMPA OFF
          </button>
          <button class="btn-refresh" onclick="refreshAll()">
            ⟳ Aggiorna ora
          </button>
        </div>

        <div class="muted" id="pump-note" style="margin-top:6px;">
          In attesa dei dati da ThingSpeak…
        </div>
      </div>
    </div>

    <!-- Sensori testa/base -->
    <div class="card">
      <h2>Sensori BME280 (Testa / Base)</h2>
      <table>
        <thead>
          <tr>
            <th>Posizione</th>
            <th>T [°C]</th>
            <th>UR [%]</th>
            <th>Press. [hPa]</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Testa (field3–5)</td>
            <td class="val" id="t-testa">–</td>
            <td class="val" id="h-testa">–</td>
            <td class="val" id="p-testa">–</td>
          </tr>
          <tr>
            <td>Base (field6–8)</td>
            <td class="val" id="t-base">–</td>
            <td class="val" id="h-base">–</td>
            <td class="val" id="p-base">–</td>
          </tr>
        </tbody>
      </table>
      <div class="muted" id="sensors-note" style="margin-top:6px;">
        Ultimo campione: –
      </div>
    </div>

    <!-- Log -->
    <div class="card" style="grid-column: 1 / -1;">
      <h2>Log / Diagnostica</h2>
      <div id="log"></div>
    </div>
  </section>

  <footer>
    Dati da ThingSpeak · lettura automatica ogni 10 s · ricorda che il piano free ha limiti di rate.
  </footer>
</main>

<script>
  // === CONFIGURAZIONE THINGSPEAK ===
  const CHANNEL_ID    = 2862116;
  const READ_API_KEY  = "IZCUGF40MLOCNBG9";
  const WRITE_API_KEY = "FBHJWWWILCJK3YFT";

  const POLL_INTERVAL_MS = 10000;   // lettura ogni 10 s

  // === RIFERIMENTI DOM ===
  const pumpBadge    = document.getElementById("pump-status-badge");
  const commandBadge = document.getElementById("command-status");
  const pumpNote     = document.getElementById("pump-note");
  const sensorsNote  = document.getElementById("sensors-note");
  const lastSync     = document.getElementById("last-sync");
  const logDiv       = document.getElementById("log");
  const btnOn        = document.getElementById("btn-on");
  const btnOff       = document.getElementById("btn-off");

  const tTestaSpan = document.getElementById("t-testa");
  const hTestaSpan = document.getElementById("h-testa");
  const pTestaSpan = document.getElementById("p-testa");
  const tBaseSpan  = document.getElementById("t-base");
  const hBaseSpan  = document.getElementById("h-base");
  const pBaseSpan  = document.getElementById("p-base");

  let lastCommand = null;
  let awaitingConfirm = false;
  let lastCommandTime = 0;

  // === FUNZIONI DI UTILITÀ ===
  function log(msg, level = "ok") {
    const now = new Date().toLocaleTimeString();
    const p = document.createElement("div");
    p.className = `log-line ${level}`;
    p.textContent = `[${now}] ${msg}`;
    logDiv.prepend(p);
  }

  function setPumpBadge(state) {
    pumpBadge.className = "badge";
    if (state === 1) {
      pumpBadge.classList.add("badge-on");
      pumpBadge.textContent = "ON";
    } else if (state === 0) {
      pumpBadge.classList.add("badge-off");
      pumpBadge.textContent = "OFF";
    } else {
      pumpBadge.classList.add("badge-error");
      pumpBadge.textContent = "Sconosciuto";
    }
  }

  function setCommandBadge(val) {
    commandBadge.className = "badge";
    if (val === 1) {
      commandBadge.classList.add("badge-on");
      commandBadge.textContent = "ON";
    } else if (val === 0) {
      commandBadge.classList.add("badge-off");
      commandBadge.textContent = "OFF";
    } else {
      commandBadge.classList.add("badge-error");
      commandBadge.textContent = "Nessuno";
    }
  }

  function setButtonsEnabled(enabled) {
    btnOn.disabled  = !enabled;
    btnOff.disabled = !enabled;
  }

  // === INVIO COMANDO POMPA ===
  function setPump(value) {
    lastCommand = value;
    awaitingConfirm = true;
    lastCommandTime = Date.now();
    setButtonsEnabled(false);

    pumpNote.textContent = `Invio comando ${value === 1 ? "ON" : "OFF"} a ThingSpeak…`;
    setCommandBadge(value);

    const url = `https://api.thingspeak.com/update?api_key=${WRITE_API_KEY}&field1=${value}`;
    log(`Invio comando field1=${value}`, "ok");

    fetch(url)
      .then(r => r.text())
      .then(data => {
        const id = parseInt(data);
        if (isNaN(id) || id <= 0) {
          log(`ThingSpeak NON ha registrato il comando (risposta: ${data})`, "err");
          pumpNote.textContent = "Errore: comando non registrato (limite di rate o chiave errata).";
          awaitingConfirm = false;
          setButtonsEnabled(true);
        } else {
          log(`Comando registrato su ThingSpeak, entryId=${id}`, "ok");
          pumpNote.textContent = "Comando registrato, in attesa che Arduino aggiorni lo stato…";
          // fra poco la lettura automatica controllerà field2
        }
      })
      .catch(err => {
        log("Errore invio comando: " + err, "err");
        pumpNote.textContent = "Errore di rete nell’invio comando.";
        awaitingConfirm = false;
        setButtonsEnabled(true);
      });
  }

  // === LETTURA COMPLETA ULTIMO CAMPIONE ===
  function refreshAll() {
    const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=1`;

    fetch(url)
      .then(r => r.json())
      .then(json => {
        if (!json.feeds || json.feeds.length === 0) {
          log("Nessun feed disponibile dal canale.", "warn");
          return;
        }

        const feed = json.feeds[0];
        const updated = new Date(feed.created_at);

        // Field1 = ultimo comando, Field2 = stato reale pompa
        const f1 = feed.field1 !== null ? parseInt(feed.field1) : null;
        const f2 = feed.field2 !== null ? parseInt(feed.field2) : null;

        setCommandBadge(
          f1 === 0 || f1 === 1 ? f1 : null
        );
        setPumpBadge(
          f2 === 0 || f2 === 1 ? f2 : null
        );

        // Nota di stato pompa
        if (f2 === 1) {
          pumpNote.textContent = "Pompa segnalata ATTIVA da Arduino.";
        } else if (f2 === 0) {
          pumpNote.textContent = "Pompa segnalata SPENTA da Arduino.";
        } else {
          pumpNote.textContent = "Stato pompa non disponibile.";
        }

        // Conferma comando (field1 vs field2)
        if (awaitingConfirm && (f2 === 0 || f2 === 1)) {
          if (f2 === lastCommand) {
            log("Comando confermato: stato pompa combacia con field1.", "ok");
            pumpNote.textContent += " (comando confermato)";
            awaitingConfirm = false;
          } else if (Date.now() - lastCommandTime > 30000) {
            log("ATTENZIONE: comando non confermato entro 30s.", "warn");
            pumpNote.textContent += " (comando non confermato entro 30s)";
            awaitingConfirm = false;
          }
        }

        // Sensori testa/base
        const f3 = feed.field3, f4 = feed.field4, f5 = feed.field5;
        const f6 = feed.field6, f7 = feed.field7, f8 = feed.field8;

        tTestaSpan.textContent = f3 !== null ? parseFloat(f3).toFixed(2) : "–";
        hTestaSpan.textContent = f4 !== null ? parseFloat(f4).toFixed(2) : "–";
        pTestaSpan.textContent = f5 !== null ? parseFloat(f5).toFixed(2) : "–";

        tBaseSpan.textContent  = f6 !== null ? parseFloat(f6).toFixed(2) : "–";
        hBaseSpan.textContent  = f7 !== null ? parseFloat(f7).toFixed(2) : "–";
        pBaseSpan.textContent  = f8 !== null ? parseFloat(f8).toFixed(2) : "–";

        sensorsNote.textContent = "Ultimo campione: " + updated.toLocaleString();
        lastSync.textContent = "Ultimo aggiornamento: " + new Date().toLocaleTimeString();
        setButtonsEnabled(true);
      })
      .catch(err => {
        log("Errore lettura dati da ThingSpeak: " + err, "err");
      });
  }

  // === AVVIO ===
  log("Dashboard avviata. Lettura iniziale dati…", "ok");
  refreshAll();
  setInterval(refreshAll, POLL_INTERVAL_MS);
</script>
</body>
</html>
